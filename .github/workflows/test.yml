name: Android Appium Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  android-login-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Setup Android SDK
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 30
        target: google_apis
        arch: x86_64
        force-avd-creation: true
        emulator-options: "-no-window -no-audio -no-snapshot -gpu swiftshader_indirect"
        disable-animations: true
        script: echo "Emulator Ready!"

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
      
    - name: Install Python Dependencies
      run: |
        pip install -r requirements.txt
        pip install allure-pytest

    - name: Install Appium & Drivers
      run: |
        npm install -g appium
        appium driver install uiautomator2

    - name: Run Appium Server
      run: |
        nohup appium --allow-insecure chromedriver_autodownload > appium.log 2>&1 &

    - name: Wait for Appium to be ready
      run: |
        for i in {1..15}
        do
          nc -z localhost 4723 && echo "Appium is up!" && exit 0
          echo "Waiting for Appium..."
          sleep 2
        done
        echo "Appium did not start in time" && exit 1

    - name: Run Pytest with Allure
      run: |
        adb devices
        pytest --alluredir=allure-results

    - name: Upload Allure Results
      uses: actions/upload-artifact@v4
      with:
        name: allure-results
        path: allure-results

    - name: Notify Slack
      if: always()
      run: |
        if [ -f "allure-results/summary.json" ]; then
          TOTAL=$(grep -o '"total": *[0-9]*' allure-results/summary.json | grep -o '[0-9]*')
          FAILED=$(grep -o '"failed": *[0-9]*' allure-results/summary.json | grep -o '[0-9]*')
          PASSED=$(grep -o '"passed": *[0-9]*' allure-results/summary.json | grep -o '[0-9]*')
        else
          TOTAL=unknown
          FAILED=unknown
          PASSED=unknown
        fi

        curl -X POST -H 'Content-type: application/json' --data "{
          \"text\": \"‚úÖ *Android Appium ÌÖåÏä§Ìä∏ Í≤∞Í≥º*\nÏ¥ù: $TOTAL, ÏÑ±Í≥µ: $PASSED, Ïã§Ìå®: $FAILED\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|üîó ÏÉÅÏÑ∏ Î≥¥Í∏∞>\"
        }" $SLACK_WEBHOOK_URL
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
