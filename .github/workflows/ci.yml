name: Android Appium Real Device Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  real-device-appium-test:
    runs-on: self-hosted

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Setup Python & Appium
      run: |
        pip install -r requirements.txt
        pip install allure-pytest
        npm install -g appium
        appium driver install uiautomator2

    - name: Check Connected Device
      run: |
        adb devices
        COUNT=$(adb devices | grep -w "device" | wc -l)
        if [ "$COUNT" -eq 0 ]; then
          echo "âŒ ì‹¤ì œ ë””ë°”ì´ìŠ¤ê°€ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
          exit 1
        fi

    - name: Run Appium & Tests on Real Device
      run: |
        nohup appium --allow-insecure chromedriver_autodownload > appium.log 2>&1 &

        # Wait for Appium to be ready
        for i in {1..15}
        do
          nc -z localhost 4723 && echo "Appium is up!" && break
          echo "Waiting for Appium..."
          sleep 2
        done

        pytest --alluredir=allure-results

    - name: Generate Allure Report
      run: |
        npm install -g allure-commandline --save-dev
        allure generate allure-results -o allure-report --clean

    # - name: Deploy Allure Report to GitHub Pages
    #   uses: peaceiris/actions-gh-pages@v3
    #   with:
    #     github_token: ${{ secrets.GITHUB_TOKEN }}
    #     publish_dir: ./allure-report
    #     publish_branch: gh-pages
    #     force_orphan: true

    - name: Notify Slack
      if: always()
      run: |
        REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

        if [ -f "allure-results/summary.json" ]; then
          TOTAL=$(grep -o '"total": *[0-9]*' allure-results/summary.json | grep -o '[0-9]*')
          FAILED=$(grep -o '"failed": *[0-9]*' allure-results/summary.json | grep -o '[0-9]*')
          PASSED=$(grep -o '"passed": *[0-9]*' allure-results/summary.json | grep -o '[0-9]*')

          MESSAGE="ğŸ“± *ì‹¤ì œ ë””ë°”ì´ìŠ¤ í…ŒìŠ¤íŠ¸ ê²°ê³¼*\nì´: $TOTAL, ì„±ê³µ: $PASSED, ì‹¤íŒ¨: $FAILED\nğŸ“Š Allure ë¦¬í¬íŠ¸: $REPORT_URL\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|ğŸ”— GitHub Actions ê²°ê³¼ ë³´ê¸°>"
        else
          if [ "${{ job.status }}" == "success" ]; then
            MESSAGE="âœ… *ì‹¤ì œ ë””ë°”ì´ìŠ¤ í…ŒìŠ¤íŠ¸ ì„±ê³µ*\n(Allure ë¦¬í¬íŠ¸ ì—†ìŒ)\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|ğŸ”— ìƒì„¸ ë³´ê¸°>"
          else
            MESSAGE="âŒ *ì‹¤ì œ ë””ë°”ì´ìŠ¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨*\n(Allure ë¦¬í¬íŠ¸ ì—†ìŒ)\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|ğŸ”— ìƒì„¸ ë³´ê¸°>"
          fi
        fi

        curl -X POST -H 'Content-type: application/json' --data "{
          \"text\": \"$MESSAGE\"
        }" $SLACK_WEBHOOK_URL
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
