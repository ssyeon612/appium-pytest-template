name: Android Appium Real Device Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  real-device-appium-test:
    runs-on: self-hosted

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Setup Python & Appium
      run: |
        pip install -r requirements.txt
        pip install allure-pytest
        npm install -g appium

        # uiautomator2 ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸ë§Œ ì‹¤í–‰
        appium driver update uiautomator2 || exit 0
      shell: pwsh

    - name: Check Connected Device
      run: |
        $devices = & adb devices | Select-String "device$"
        if ($devices.Count -eq 0) {
          Write-Host "âŒ ì‹¤ì œ ë””ë°”ì´ìŠ¤ê°€ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
          exit 1
        }
        Write-Host "âœ… ë””ë°”ì´ìŠ¤ ì—°ê²° í™•ì¸ë¨."
      shell: pwsh

    - name: Run Appium & Tests on Real Device
      run: |
        Start-Process -FilePath "cmd.exe" -ArgumentList "/c npx appium" -NoNewWindow

        for ($i = 0; $i -lt 15; $i++) {
          try {
            Test-NetConnection -ComputerName "localhost" -Port 4723 -WarningAction SilentlyContinue | Out-Null
            if ($?) {
              Write-Host "Appium is up!"
              break
            }
          } catch {}
          Write-Host "Waiting for Appium..."
          Start-Sleep -Seconds 2
        }

        pytest --alluredir=allure-results
      shell: pwsh

    - name: Generate Allure Report
      run: |
        npm install -g allure-commandline --save-dev
        allure generate allure-results -o allure-report --clean
      shell: pwsh

    # - name: Deploy Allure Report to GitHub Pages
    #   uses: peaceiris/actions-gh-pages@v3
    #   with:
    #     github_token: ${{ secrets.GITHUB_TOKEN }}
    #     publish_dir: ./allure-report
    #     publish_branch: gh-pages
    #     force_orphan: true

    - name: Notify Slack
      if: always()
      run: |
        $reportUrl = "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        $runUrl = "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

        if (Test-Path "allure-results/summary.json") {
          $json = Get-Content "allure-results/summary.json" | ConvertFrom-Json
          $total = $json.statistic.total
          $failed = $json.statistic.failed
          $passed = $json.statistic.passed

          $message = "ğŸ“± *ì‹¤ì œ ë””ë°”ì´ìŠ¤ í…ŒìŠ¤íŠ¸ ê²°ê³¼*`nì´: $total, ì„±ê³µ: $passed, ì‹¤íŒ¨: $failed`nğŸ“Š Allure ë¦¬í¬íŠ¸: $reportUrl`n<${runUrl}|ğŸ”— GitHub Actions ê²°ê³¼ ë³´ê¸°>"
        }
        else {
          if ("${{ job.status }}" -eq "success") {
            $message = "âœ… *ì‹¤ì œ ë””ë°”ì´ìŠ¤ í…ŒìŠ¤íŠ¸ ì„±ê³µ*`n(Allure ë¦¬í¬íŠ¸ ì—†ìŒ)`n<${runUrl}|ğŸ”— ìƒì„¸ ë³´ê¸°>"
          }
          else {
            $message = "âŒ *ì‹¤ì œ ë””ë°”ì´ìŠ¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨*`n(Allure ë¦¬í¬íŠ¸ ì—†ìŒ)`n<${runUrl}|ğŸ”— ìƒì„¸ ë³´ê¸°>"
          }
        }

        Invoke-RestMethod -Uri $env:SLACK_WEBHOOK_URL -Method Post -ContentType 'application/json' -Body (@{ text = $message } | ConvertTo-Json -Compress)
      shell: pwsh
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
